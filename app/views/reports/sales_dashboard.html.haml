.content-wrapper
  .content-header
    .container-fluid
      .row.mb-3
        .col-md-12
          %ol.breadcrumb
            %li.breadcrumb-item
              %a{:href => "/"} Home
            %li.breadcrumb-item.active Sales Dashboard
          %h1.m-0.text-dark Sales Dashboard
          .row.mb-3
            .col-md-12
              = form_tag request.path, method: :get do
                .card.shadow-sm
                  .card-body.py-4.px-4
                    .row.g-3
                      .col-md-3.mb-3
                        = label_tag :start_date, 'Visit Date From *', class: 'form-label mb-2 font-weight-bold text-secondary'
                        - start_date = params[:start_date].present? ? params[:start_date] : (Date.current - 30.days).strftime('%d-%m-%Y')
                        = text_field_tag :start_date, start_date, class: 'form-control dateFormat', required: true, id: 'visited_date_from', autocomplete: 'off', placeholder: 'DD-MM-YYYY'
                      
                      .col-md-3.mb-3
                        = label_tag :end_date, 'Visit Date Upto *', class: 'form-label mb-2 font-weight-bold text-secondary'
                        - end_date = params[:end_date].present? ? params[:end_date] : Date.current.strftime('%d-%m-%Y')
                        = text_field_tag :end_date, end_date, class: 'form-control dateFormat', required: true, id: 'visited_date_upto', autocomplete: 'off', placeholder: 'DD-MM-YYYY'
                      
                      .col-md-3.mb-3
                        = label_tag :booking_date_from, 'Booking From', class: 'form-label mb-2 font-weight-bold text-secondary'
                        = text_field_tag :booking_date_from, (params[:booking_date_from].to_date.strftime('%d-%m-%Y') rescue nil), class: 'form-control dateFormat', id: 'booking_date_from', autocomplete: 'off', placeholder: 'DD-MM-YYYY'
                      
                      .col-md-3.mb-3
                        = label_tag :booking_date_to, 'Booking Upto', class: 'form-label mb-2 font-weight-bold text-secondary'
                        = text_field_tag :booking_date_to, (params[:booking_date_to].to_date.strftime('%d-%m-%Y') rescue nil), class: 'form-control dateFormat', id: 'booking_date_upto', autocomplete: 'off', placeholder: 'DD-MM-YYYY'
                    
                    .row.g-3
                      .col-md-3.mb-3
                        = label_tag :project_id, "Project Name *", class: "form-label mb-2 font-weight-bold text-secondary"
                        = select_tag :project_id,
                          options_from_collection_for_select(@projects, :id, :name, params[:project_id]),
                          multiple: true,
                          include_blank: "Select Project",
                          class: "tomselect-checkbox form-control"
                      
                      .col-md-2.mb-3
                        = label_tag :source_ids, "Source (Optional)", class: "form-label mb-2 font-weight-bold text-secondary"
                        = select_tag :source_ids,
                          options_from_collection_for_select(@sources, :id, :name, params[:source_ids]),
                          multiple: true,
                          include_blank: "All Sources",
                          class: "tomselect-checkbox form-control"
                      
                      .col-md-2.mb-3
                        = label_tag :status_ids, "Status (Optional)", class: "form-label mb-2 font-weight-bold text-secondary"
                        = select_tag :status_ids,
                          options_from_collection_for_select(@statuses, :id, :name, params[:status_ids]),
                          multiple: true,
                          include_blank: "All Statuses",
                          class: "tomselect-checkbox form-control"
                      
                      .col-md-1.mb-3.d-flex.flex-column.justify-content-end
                        = submit_tag "Apply",
                          class: "btn btn-success btn-block font-weight-bold mb-2",
                          id: "filter-btn",
                          disabled: true
                        - if params[:project_id].present?
                          = link_to "Clear Filters", request.path, class: "btn btn-outline-secondary btn-sm btn-block"

  .content
    .container-fluid
      .card
        .card-header.bg-success.text-white
          %h5.mb-0 Sales Dashboard View

        .card-body
          .row.text-center.mb-1.align-items-start
            .col-md-2
              .w-100
                %h6.border.p-1.mb-1.font-weight-bold.text-center Total Walkins
                - if @walkin_count > 0
                  - visit_params = { start_date: @start_date, end_date: @end_date, project_id: params[:project_id] }
                  - visit_params[:source_ids] = params[:source_ids] if params[:source_ids].present?
                  - visit_params[:status_ids] = params[:status_ids] if params[:status_ids].present?
                  = link_to reports_visits_path(visit_params), target: "_blank", class: "text-decoration-none d-block clickable-card" do
                    .d-inline-block.bg-info.text-white.font-italic.font-weight-bold.text-center.align-middle.w-100.mb-1.clickable-box{style: "height: 50px; line-height: 1.2; font-size: 0.85rem; padding-top: 4px; position: relative;"}
                      VISITS
                      %div{style: "font-size: 1rem; font-weight: bold;"}= @walkin_count
                      .click-indicator{style: "position: absolute; top: 2px; right: 5px; font-size: 10px; opacity: 0.8;"} ↗
                - else
                  .d-inline-block.bg-info.text-white.font-italic.font-weight-bold.text-center.align-middle.w-100.mb-1{style: "height: 50px; line-height: 1.2; font-size: 0.85rem; padding-top: 4px; opacity: 0.6;"}
                    VISITS
                    %div{style: "font-size: 1rem; font-weight: bold;"}= @walkin_count

            .col-md-2
              .w-100
                %h6.border.p-1.mb-1.font-weight-bold.text-center Total Bookings
                - if @booking_count > 0
                  - booking_params = { "is_advanced_search" => "true", "project_ids" =>params[:project_id], "visited_date_from" => @start_date, "visited_date_upto" => @end_date, :lead_statuses => @lead_statuses, "visited" => "true", booking_date_from: params[:booking_date_from], booking_date_to: params[:booking_date_to] }
                  - booking_params[:source_ids] = params[:source_ids] if params[:source_ids].present?
                  - booking_params[:status_ids] = params[:status_ids] if params[:status_ids].present?
                  = link_to leads_path(booking_params), target: "_blank", class: "text-decoration-none d-block clickable-card" do
                    .d-inline-block.bg-primary.text-white.font-italic.font-weight-bold.text-center.align-middle.w-100.mb-1.clickable-box{style: "height: 50px; line-height: 1.2; font-size: 0.85rem; padding-top: 4px; position: relative;"}
                      BOOKINGS
                      %div{style: "font-size: 1rem; font-weight: bold;"}= @booking_count
                      .click-indicator{style: "position: absolute; top: 2px; right: 5px; font-size: 10px; opacity: 0.8;"} ↗
                - else
                  .d-inline-block.bg-primary.text-white.font-italic.font-weight-bold.text-center.align-middle.w-100.mb-1{style: "height: 50px; line-height: 1.2; font-size: 0.85rem; padding-top: 4px; opacity: 0.6;"}
                    BOOKINGS
                    %div{style: "font-size: 1rem; font-weight: bold;"}= @booking_count

            .col-md-2
              .w-100
                %h6.border.p-1.mb-1.font-weight-bold.text-center Total CPs
                .d-inline-block.bg-dark.text-white.font-italic.font-weight-bold.text-center.align-middle.w-100.mb-1{style: "height: 50px; line-height: 1.2; font-size: 0.85rem; padding-top: 4px;"}
                  CPs
                  %div{style: "font-size: 1rem; font-weight: bold;"}= @cp_count

            .col-md-3{style: "margin-left: 200px;"}
              .w-100
                %h6.text-dark.font-weight-bold.mb-1 Channel wise Site Visits
                .d-flex.justify-content-center
                  %canvas#channelChart{ width: "100", height: "100", style: "max-width: 100%; height: 180px; width: 250px;" }

          %hr

          - if @leads&.any?
            %h5.mt-5 Customer Detail
            
            - # Preload last visit dates for all leads in one query
            - last_visit_dates = Leads::Visit.where(lead_id: @leads.map(&:id)).group(:lead_id).maximum(:date)
            
            #pagination-info.pagination-custom-holder.mb-3
              %label{style: "margin-left: 0;"} 
                Showing #{(@leads.offset_value || 0) + 1} - #{(@leads.offset_value || 0) + @leads.length} of #{@leads.total_entries} leads
              = will_paginate @leads, class: "ct-pag"
            
            #customer-table-container
              %table.table.table-bordered.table-sm.table-hover
                %thead.thead-light
                  %tr
                    %th{style: "min-width: 100px;"} Date
                    %th{style: "min-width: 120px;"} Project
                    %th{style: "min-width: 150px;"} Customer Name
                    %th{style: "min-width: 100px;"} Channel
                    %th{style: "min-width: 150px;"} Channel Partner
                    %th{style: "min-width: 100px;"} Lead Status
                    %th{style: "min-width: 100px;"} Booking Date
                    %th{style: "min-width: 100px;"} Occupation
                    %th{style: "min-width: 60px;"} Age
                    %th{style: "min-width: 100px;"} Family/Not Fam
                    %th{style: "min-width: 120px;"} Self-funded/Loan
                    %th{style: "min-width: 80px;"} Use
                    %th{style: "min-width: 80px;"} Unit
                    %th{style: "min-width: 150px;"} Home Address
                    %th{style: "min-width: 150px;"} Office Address
                %tbody#leads-tbody
                  - @leads.each_with_index do |lead, index|
                    - magic = @lead_magic_values[lead.id] || {}
                    %tr{data: {index: index}}
                      %td= last_visit_dates[lead.id]&.strftime("%d-%m-%Y") || "No Visit"
                      %td= lead.project&.name
                      %td= lead.name.presence || "Unnamed"
                      %td= lead.source&.name || "N/A"
                      %td
                        - if lead.source&.name == "Channel Partner" && lead.broker
                          = lead.broker.name || "Unnamed Broker"
                        - else
                          N/A
                      %td= lead.status&.name
                      %td= lead.booking_date&.strftime('%d-%m-%Y %H:%M:%S')
                      %td= magic["occupation"] || ""
                      %td= magic["age"] || ""
                      %td= magic["family/not fam"] || ""
                      %td= magic["self-funded/loan"] || ""
                      %td= magic["use"] || ""
                      %td= magic["unit"] || ""
                      %td= magic["home address"] || ""
                      %td= magic["office address"] || ""
            
            #pagination-bottom.pagination-custom-holder.mt-3
              = will_paginate @leads, class: "ct-pag"
              
          - else
            #no-data-message.text-center.mt-5.py-5
              - if params[:project_id].present? && @start_date.present? && @end_date.present?
                %h3.text-muted.font-weight-bold.mb-3 No Data Found
                %p.text-muted.lead 
                  No customer visits found for the selected project and date range.
                  %br
                  Please try different filters or adjust your date range.
              - else
                %h3.text-muted.font-weight-bold.mb-5 Apply Filters to View Data
                %p.text-muted.mb-5
                  Please select a project and visit date range, then click "Filter" 
                  %br
                  to view customer visit details and analytics.

:css
  .card.shadow-sm {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
  }

  .card.shadow-sm .card-body {
    padding: 1rem 1rem !important;
  }

  .card.shadow-sm .row.g-3 {
    margin-bottom: 0.5rem;
  }

  .card.shadow-sm .row.g-3:last-child {
    margin-bottom: 0;
  }

  .card.shadow-sm .mb-3 {
    margin-bottom: 0.75rem !important;
  }

  .form-label.small {
    font-size: 0.85rem;
    color: #495057;
    margin-bottom: 0.25rem;
  }

  .form-label.mb-2 {
    margin-bottom: 0.25rem !important;
  }

  .form-control {
    border-radius: 4px;
    border: 1px solid #ced4da;
    font-size: 0.9rem;
  }

  .btn-success {
    background-color: #28a745;
    border-color: #28a745;
    font-weight: 500;
    padding: 0.5rem 1rem;
    border-radius: 4px;
  }

  .btn-success:hover {
    background-color: #218838;
    border-color: #1e7e34;
  }

  .btn-success:disabled {
    background-color: #6c757d;
    border-color: #6c757d;
    opacity: 0.65;
  }

  .btn-outline-secondary {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
  }

  .card-body .row.text-center.mb-1 {
    margin-bottom: 0.5rem !important;
  }

  .card-body hr {
    margin-top: 0.5rem;
    margin-bottom: 0.5rem;
  }

  .card-body h5.mt-5 {
    margin-top: 1rem !important;
  }

  @media (max-width: 1200px) {
    .row.align-items-end > div {
      margin-bottom: 1rem;
    }
  }

  .clickable-card {
    transition: all 0.2s ease;
  }

  .clickable-box {
    cursor: pointer;
    transition: all 0.2s ease;
    border: 2px solid transparent;
    position: relative;
  }

  .clickable-box:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    border-color: #fff;
    opacity: 0.9 !important;
  }

  .table {
    font-size: 0.875rem;
  }

  .table td, .table th {
    padding: 0.5rem 0.75rem;
    vertical-align: middle;
    border: 1px solid #dee2e6;
  }

  .table-hover tbody tr:hover {
    background-color: rgba(0,0,0,0.025);
  }

  #customer-table-container {
    position: relative;
    overflow-x: auto;
  }

  #customer-table-container:not(:empty) {
    max-height: 600px;
    overflow-y: auto;
  }

  .thead-light th {
    position: sticky;
    top: 0;
    z-index: 10;
    background-color: #f8f9fa !important;
  }

  #no-data-message {
    min-height: 200px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    margin-top: 1rem !important;
    padding-top: 1rem !important;
    padding-bottom: 1rem !important;
  }

  #no-data-message h3 {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 1rem !important;
  }

  #no-data-message .lead {
    font-size: 1rem;
    line-height: 1.5;
    margin-bottom: 1rem !important;
  }

  .datepicker::-webkit-calendar-picker-indicator {
    display: none !important;
  }

  .datepicker {
    background-color: white !important;
    -webkit-appearance: none;
  }

:javascript
  document.addEventListener("DOMContentLoaded", function () {
    const filterBtn = document.getElementById("filter-btn");
    const project = document.getElementById("project_id");
    const dateFrom = document.getElementById("visited_date_from");
    const dateUpto = document.getElementById("visited_date_upto");

    function validateFilters() {
      if (filterBtn && project && dateFrom && dateUpto) {
        filterBtn.disabled = !(project.value && dateFrom.value && dateUpto.value);
      }
    }

    [project, dateFrom, dateUpto].forEach(el => {
      if (el) {
        el.addEventListener("input", validateFilters);
        el.addEventListener("change", validateFilters);
      }
    });

    validateFilters();

    if (document.getElementById("channelChart")) {
      initializeChart();
    }
  });

  function initializeChart() {
    const ctx = document.getElementById("channelChart").getContext("2d");
    const chartData = #{raw @channel_data.to_json};
    const labels = Object.keys(chartData);
    const data = Object.values(chartData);
    
    const colors = [
      '#7cb5ec', '#434348', '#90ed7d', '#f7a35c', '#8085e9',
      '#f15c80', '#e4d354', '#2b908f', '#f45b5b', '#91e8e1',
      '#1abc9c', '#3498db', '#9b59b6', '#34495e', '#2ecc71'
    ];

    new Chart(ctx, {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{
          label: "Channel Wise Customer",
          data: data,
          backgroundColor: colors.slice(0, labels.length),
          borderWidth: 1,
          borderColor: '#fff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 300 },
        plugins: {
          legend: {
            position: 'left',
            labels: {
              usePointStyle: true,
              pointStyle: 'circle',
              boxWidth: 8,
              boxHeight: 8,
              font: { size: 11 }
            }
          },
          tooltip: {
            animation: { duration: 0 },
            callbacks: {
              label: function (context) {
                const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                const value = context.parsed;
                const percent = ((value / total) * 100).toFixed(1);
                return `${context.label}: ${value} (${percent}%)`;
              }
            }
          }
        }
      }
    });
  }

  function loadChartJS() {
    if (!window.Chart) {
      const script = document.createElement("script");
      script.src = "https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js";
      script.onload = initializeChart;
      document.head.appendChild(script);
    }
  }

  setTimeout(loadChartJS, 100);
